{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import { ImageBase } from \"@vibrant/image\";\nimport configure from \"@jimp/custom\";\nimport types from \"@jimp/types\";\nimport resize from \"@jimp/plugin-resize\";\nimport type { ImageData, ImageSource } from \"@vibrant/image\";\n\nconst Jimp = configure({\n\ttypes: [types],\n\tplugins: [resize],\n});\n\nconst URL_REGEX = /^(\\w+):\\/\\/.*/i;\n\ntype NodeImageSource = string | Buffer;\n\nexport class NodeImage extends ImageBase {\n\tprivate _image: InstanceType<typeof Jimp> | undefined;\n\n\tprivate _getImage() {\n\t\tif (!this._image) {\n\t\t\tthrow new Error(\"Image not loaded\");\n\t\t}\n\t\treturn this._image;\n\t}\n\n\tprivate async _loadByProtocolHandler(src: string): Promise<Buffer> {\n\t\tconst res = await fetch(src, {\n\t\t\tmethod: \"GET\",\n\t\t});\n\n\t\tif (!res.ok || !res.body) {\n\t\t\tthrow new Error(`Failed to fetch ${src}`);\n\t\t}\n\n\t\tconst stream = res.body.getReader();\n\t\tconst chunks: Uint8Array[] = [];\n\t\tlet done = false;\n\t\twhile (!done) {\n\t\t\tconst { value, done: doneValue } = await stream.read();\n\t\t\tif (value) {\n\t\t\t\tchunks.push(value);\n\t\t\t}\n\t\t\tdone = doneValue;\n\t\t}\n\n\t\treturn Buffer.concat(chunks);\n\t}\n\n\tprivate _loadFromPath(src: string): Promise<ImageBase> {\n\t\tconst m = URL_REGEX.exec(src);\n\t\tif (m) {\n\t\t\treturn this._loadByProtocolHandler(src).then((buf) =>\n\t\t\t\tthis._loadByJimp(buf),\n\t\t\t);\n\t\t} else {\n\t\t\treturn this._loadByJimp(src);\n\t\t}\n\t}\n\n\tprivate _loadByJimp(src: NodeImageSource): Promise<ImageBase> {\n\t\t// NOTE: TypeScript doesn't support union type to overloads yet\n\t\t//       Use type assertion to bypass compiler error\n\t\treturn Jimp.read(src as Buffer).then((result) => {\n\t\t\tthis._image = result;\n\t\t\treturn this;\n\t\t});\n\t}\n\n\tload(image: ImageSource): Promise<ImageBase> {\n\t\tif (typeof image === \"string\") {\n\t\t\treturn this._loadFromPath(image);\n\t\t} else if (image instanceof Buffer) {\n\t\t\treturn this._loadByJimp(image);\n\t\t} else {\n\t\t\treturn Promise.reject(\n\t\t\t\tnew Error(\n\t\t\t\t\t\"Cannot load image from HTMLImageElement in node environment\",\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\t}\n\n\tclear(): void {}\n\n\tupdate(_imageData: ImageData): void {}\n\n\tgetWidth(): number {\n\t\treturn this._getImage().bitmap.width;\n\t}\n\n\tgetHeight(): number {\n\t\treturn this._getImage().bitmap.height;\n\t}\n\n\tresize(targetWidth: number, targetHeight: number, _ratio: number): void {\n\t\tthis._getImage().resize(targetWidth, targetHeight);\n\t}\n\n\tgetPixelCount(): number {\n\t\tconst bitmap = this._getImage().bitmap;\n\t\treturn bitmap.width * bitmap.height;\n\t}\n\n\tgetImageData(): ImageData {\n\t\treturn this._getImage().bitmap;\n\t}\n\n\tremove(): void {}\n}\n"],"names":[],"mappings":";;;;AAMA,MAAM,OAAO,UAAU;AAAA,EACtB,OAAO,CAAC,KAAK;AAAA,EACb,SAAS,CAAC,MAAM;AACjB,CAAC;AAED,MAAM,YAAY;AAIX,MAAM,kBAAkB,UAAU;AAAA,EAGhC,YAAY;AACnB,QAAI,CAAC,KAAK,QAAQ;AACjB,YAAM,IAAI,MAAM,kBAAkB;AAAA,IACnC;AACA,WAAO,KAAK;AAAA,EACb;AAAA,EAEA,MAAc,uBAAuB,KAA8B;AAClE,UAAM,MAAM,MAAM,MAAM,KAAK;AAAA,MAC5B,QAAQ;AAAA,IAAA,CACR;AAED,QAAI,CAAC,IAAI,MAAM,CAAC,IAAI,MAAM;AACzB,YAAM,IAAI,MAAM,mBAAmB,GAAG,EAAE;AAAA,IACzC;AAEA,UAAM,SAAS,IAAI,KAAK,UAAA;AACxB,UAAM,SAAuB,CAAA;AAC7B,QAAI,OAAO;AACX,WAAO,CAAC,MAAM;AACb,YAAM,EAAE,OAAO,MAAM,cAAc,MAAM,OAAO,KAAA;AAChD,UAAI,OAAO;AACV,eAAO,KAAK,KAAK;AAAA,MAClB;AACA,aAAO;AAAA,IACR;AAEA,WAAO,OAAO,OAAO,MAAM;AAAA,EAC5B;AAAA,EAEQ,cAAc,KAAiC;AACtD,UAAM,IAAI,UAAU,KAAK,GAAG;AAC5B,QAAI,GAAG;AACN,aAAO,KAAK,uBAAuB,GAAG,EAAE;AAAA,QAAK,CAAC,QAC7C,KAAK,YAAY,GAAG;AAAA,MAAA;AAAA,IAEtB,OAAO;AACN,aAAO,KAAK,YAAY,GAAG;AAAA,IAC5B;AAAA,EACD;AAAA,EAEQ,YAAY,KAA0C;AAG7D,WAAO,KAAK,KAAK,GAAa,EAAE,KAAK,CAAC,WAAW;AAChD,WAAK,SAAS;AACd,aAAO;AAAA,IACR,CAAC;AAAA,EACF;AAAA,EAEA,KAAK,OAAwC;AAC5C,QAAI,OAAO,UAAU,UAAU;AAC9B,aAAO,KAAK,cAAc,KAAK;AAAA,IAChC,WAAW,iBAAiB,QAAQ;AACnC,aAAO,KAAK,YAAY,KAAK;AAAA,IAC9B,OAAO;AACN,aAAO,QAAQ;AAAA,QACd,IAAI;AAAA,UACH;AAAA,QAAA;AAAA,MACD;AAAA,IAEF;AAAA,EACD;AAAA,EAEA,QAAc;AAAA,EAAC;AAAA,EAEf,OAAO,YAA6B;AAAA,EAAC;AAAA,EAErC,WAAmB;AAClB,WAAO,KAAK,YAAY,OAAO;AAAA,EAChC;AAAA,EAEA,YAAoB;AACnB,WAAO,KAAK,YAAY,OAAO;AAAA,EAChC;AAAA,EAEA,OAAO,aAAqB,cAAsB,QAAsB;AACvE,SAAK,UAAA,EAAY,OAAO,aAAa,YAAY;AAAA,EAClD;AAAA,EAEA,gBAAwB;AACvB,UAAM,SAAS,KAAK,UAAA,EAAY;AAChC,WAAO,OAAO,QAAQ,OAAO;AAAA,EAC9B;AAAA,EAEA,eAA0B;AACzB,WAAO,KAAK,YAAY;AAAA,EACzB;AAAA,EAEA,SAAe;AAAA,EAAC;AACjB;"}