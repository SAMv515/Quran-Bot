{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import { Quantizer } from \"@vibrant/quantizer\";\nimport { Filter, Swatch } from \"@vibrant/color\";\nimport { VBox } from \"./vbox\";\nimport { PQueue } from \"./pqueue\";\nimport type { Pixels } from \"@vibrant/image\";\nimport type { QuantizerOptions } from \"@vibrant/quantizer\";\n\nconst fractByPopulations = 0.75;\n\nfunction _splitBoxes(pq: PQueue<VBox>, target: number): void {\n\tlet lastSize = pq.size();\n\twhile (pq.size() < target) {\n\t\tconst vbox = pq.pop();\n\n\t\tif (vbox && vbox.count() > 0) {\n\t\t\tconst [vbox1, vbox2] = vbox.split();\n\n\t\t\tif (!vbox1) break;\n\n\t\t\tpq.push(vbox1);\n\t\t\tif (vbox2 && vbox2.count() > 0) pq.push(vbox2);\n\n\t\t\t// No more new boxes, converged\n\t\t\tif (pq.size() === lastSize) {\n\t\t\t\tbreak;\n\t\t\t} else {\n\t\t\t\tlastSize = pq.size();\n\t\t\t}\n\t\t} else {\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nexport const MMCQ = (pixels: Pixels, opts: QuantizerOptions): Array<Swatch> => {\n\tif (pixels.length === 0 || opts.colorCount < 2 || opts.colorCount > 256) {\n\t\tthrow new Error(\"Wrong MMCQ parameters\");\n\t}\n\n\tconst vbox = VBox.build(pixels);\n\tconst colorCount = vbox.histogram.colorCount;\n\tconst pq = new PQueue<VBox>((a, b) => a.count() - b.count());\n\n\tpq.push(vbox);\n\n\t// first set of colors, sorted by population\n\t_splitBoxes(pq, fractByPopulations * opts.colorCount);\n\n\t// Re-order\n\tconst pq2 = new PQueue<VBox>(\n\t\t(a, b) => a.count() * a.volume() - b.count() * b.volume(),\n\t);\n\tpq2.contents = pq.contents;\n\n\t// next set - generate the median cuts using the (npix * vol) sorting.\n\t_splitBoxes(pq2, opts.colorCount - pq2.size());\n\n\t// calculate the actual colors\n\treturn generateSwatches(pq2);\n};\n\nfunction generateSwatches(pq: PQueue<VBox>) {\n\tconst swatches: Swatch[] = [];\n\twhile (pq.size()) {\n\t\tconst v = pq.pop()!;\n\t\tconst color = v.avg();\n\t\tconst [r, g, b] = color;\n\t\tswatches.push(new Swatch(color, v.count()));\n\t}\n\treturn swatches;\n}\n"],"names":[],"mappings":";;;AAOA,MAAM,qBAAqB;AAE3B,SAAS,YAAY,IAAkB,QAAsB;AAC5D,MAAI,WAAW,GAAG,KAAA;AAClB,SAAO,GAAG,KAAA,IAAS,QAAQ;AAC1B,UAAM,OAAO,GAAG,IAAA;AAEhB,QAAI,QAAQ,KAAK,MAAA,IAAU,GAAG;AAC7B,YAAM,CAAC,OAAO,KAAK,IAAI,KAAK,MAAA;AAE5B,UAAI,CAAC,MAAO;AAEZ,SAAG,KAAK,KAAK;AACb,UAAI,SAAS,MAAM,MAAA,IAAU,EAAG,IAAG,KAAK,KAAK;AAG7C,UAAI,GAAG,KAAA,MAAW,UAAU;AAC3B;AAAA,MACD,OAAO;AACN,mBAAW,GAAG,KAAA;AAAA,MACf;AAAA,IACD,OAAO;AACN;AAAA,IACD;AAAA,EACD;AACD;AAEO,MAAM,OAAO,CAAC,QAAgB,SAA0C;AAC9E,MAAI,OAAO,WAAW,KAAK,KAAK,aAAa,KAAK,KAAK,aAAa,KAAK;AACxE,UAAM,IAAI,MAAM,uBAAuB;AAAA,EACxC;AAEA,QAAM,OAAO,KAAK,MAAM,MAAM;AACX,OAAK,UAAU;AAClC,QAAM,KAAK,IAAI,OAAa,CAAC,GAAG,MAAM,EAAE,MAAA,IAAU,EAAE,OAAO;AAE3D,KAAG,KAAK,IAAI;AAGZ,cAAY,IAAI,qBAAqB,KAAK,UAAU;AAGpD,QAAM,MAAM,IAAI;AAAA,IACf,CAAC,GAAG,MAAM,EAAE,MAAA,IAAU,EAAE,OAAA,IAAW,EAAE,MAAA,IAAU,EAAE,OAAA;AAAA,EAAO;AAEzD,MAAI,WAAW,GAAG;AAGlB,cAAY,KAAK,KAAK,aAAa,IAAI,MAAM;AAG7C,SAAO,iBAAiB,GAAG;AAC5B;AAEA,SAAS,iBAAiB,IAAkB;AAC3C,QAAM,WAAqB,CAAA;AAC3B,SAAO,GAAG,QAAQ;AACjB,UAAM,IAAI,GAAG,IAAA;AACb,UAAM,QAAQ,EAAE,IAAA;AAChB,UAAM,CAAC,GAAG,GAAG,CAAC,IAAI;AAClB,aAAS,KAAK,IAAI,OAAO,OAAO,EAAE,MAAA,CAAO,CAAC;AAAA,EAC3C;AACA,SAAO;AACR;"}