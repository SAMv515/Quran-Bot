{"version":3,"file":"vbox.cjs","sources":["../../src/vbox.ts"],"sourcesContent":["import { Filter } from \"@vibrant/color\";\nimport { Histogram } from \"@vibrant/image\";\nimport type { Vec3 } from \"@vibrant/color\";\nimport type { Pixels } from \"@vibrant/image\";\n\ninterface Dimension {\n\tr1: number;\n\tr2: number;\n\tg1: number;\n\tg2: number;\n\tb1: number;\n\tb2: number;\n\t[d: string]: number;\n}\n\nconst SIGBITS = 5;\nconst RSHIFT = 8 - SIGBITS;\n\n/**\n * @private\n */\nexport class VBox {\n\tstatic build(pixels: Pixels): VBox {\n\t\tconst h = new Histogram(pixels, { sigBits: SIGBITS });\n\t\tconst { rmin, rmax, gmin, gmax, bmin, bmax } = h;\n\t\treturn new VBox(rmin, rmax, gmin, gmax, bmin, bmax, h);\n\t}\n\n\tdimension: Dimension;\n\n\tprivate _volume = -1;\n\tprivate _avg: Vec3 | null = null;\n\tprivate _count = -1;\n\n\tconstructor(\n\t\tr1: number,\n\t\tr2: number,\n\t\tg1: number,\n\t\tg2: number,\n\t\tb1: number,\n\t\tb2: number,\n\t\tpublic histogram: Histogram,\n\t) {\n\t\t// NOTE: dimension will be mutated by split operation.\n\t\t//       It must be specified explicitly, not from histogram\n\t\tthis.dimension = { r1, r2, g1, g2, b1, b2 };\n\t}\n\n\tinvalidate(): void {\n\t\tthis._volume = this._count = -1;\n\t\tthis._avg = null;\n\t}\n\n\tvolume(): number {\n\t\tif (this._volume < 0) {\n\t\t\tconst { r1, r2, g1, g2, b1, b2 } = this.dimension;\n\t\t\tthis._volume = (r2 - r1 + 1) * (g2 - g1 + 1) * (b2 - b1 + 1);\n\t\t}\n\t\treturn this._volume;\n\t}\n\n\tcount(): number {\n\t\tif (this._count < 0) {\n\t\t\tconst { hist, getColorIndex } = this.histogram;\n\t\t\tconst { r1, r2, g1, g2, b1, b2 } = this.dimension;\n\t\t\tlet c = 0;\n\n\t\t\tfor (let r = r1; r <= r2; r++) {\n\t\t\t\tfor (let g = g1; g <= g2; g++) {\n\t\t\t\t\tfor (let b = b1; b <= b2; b++) {\n\t\t\t\t\t\tconst index = getColorIndex(r, g, b);\n\t\t\t\t\t\tif (!hist[index]) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tc += hist[index]!;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._count = c;\n\t\t}\n\t\treturn this._count;\n\t}\n\n\tclone(): VBox {\n\t\tconst { histogram } = this;\n\t\tconst { r1, r2, g1, g2, b1, b2 } = this.dimension;\n\t\treturn new VBox(r1, r2, g1, g2, b1, b2, histogram);\n\t}\n\n\tavg(): Vec3 {\n\t\tif (!this._avg) {\n\t\t\tconst { hist, getColorIndex } = this.histogram;\n\t\t\tconst { r1, r2, g1, g2, b1, b2 } = this.dimension;\n\t\t\tlet ntot = 0;\n\t\t\tconst mult = 1 << (8 - SIGBITS);\n\t\t\tlet rsum: number;\n\t\t\tlet gsum: number;\n\t\t\tlet bsum: number;\n\t\t\trsum = gsum = bsum = 0;\n\n\t\t\tfor (let r = r1; r <= r2; r++) {\n\t\t\t\tfor (let g = g1; g <= g2; g++) {\n\t\t\t\t\tfor (let b = b1; b <= b2; b++) {\n\t\t\t\t\t\tconst index = getColorIndex(r, g, b);\n\t\t\t\t\t\tconst h = hist[index];\n\t\t\t\t\t\tif (!h) continue;\n\t\t\t\t\t\tntot += h;\n\t\t\t\t\t\trsum += h * (r + 0.5) * mult;\n\t\t\t\t\t\tgsum += h * (g + 0.5) * mult;\n\t\t\t\t\t\tbsum += h * (b + 0.5) * mult;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (ntot) {\n\t\t\t\tthis._avg = [~~(rsum / ntot), ~~(gsum / ntot), ~~(bsum / ntot)];\n\t\t\t} else {\n\t\t\t\tthis._avg = [\n\t\t\t\t\t~~((mult * (r1 + r2 + 1)) / 2),\n\t\t\t\t\t~~((mult * (g1 + g2 + 1)) / 2),\n\t\t\t\t\t~~((mult * (b1 + b2 + 1)) / 2),\n\t\t\t\t];\n\t\t\t}\n\t\t}\n\t\treturn this._avg;\n\t}\n\n\tcontains(rgb: Vec3): boolean {\n\t\tlet [r, g, b] = rgb;\n\t\tconst { r1, r2, g1, g2, b1, b2 } = this.dimension;\n\t\tr >>= RSHIFT;\n\t\tg >>= RSHIFT;\n\t\tb >>= RSHIFT;\n\n\t\treturn r >= r1 && r <= r2 && g >= g1 && g <= g2 && b >= b1 && b <= b2;\n\t}\n\n\tsplit(): VBox[] {\n\t\tconst { hist, getColorIndex } = this.histogram;\n\t\tconst { r1, r2, g1, g2, b1, b2 } = this.dimension;\n\t\tconst count = this.count();\n\t\tif (!count) return [];\n\t\tif (count === 1) return [this.clone()];\n\t\tconst rw = r2 - r1 + 1;\n\t\tconst gw = g2 - g1 + 1;\n\t\tconst bw = b2 - b1 + 1;\n\n\t\tconst maxw = Math.max(rw, gw, bw);\n\t\tlet accSum: Uint32Array | null = null;\n\t\tlet sum: number;\n\t\tlet total: number;\n\t\tsum = total = 0;\n\n\t\tlet maxd: \"r\" | \"g\" | \"b\" | null = null;\n\n\t\tif (maxw === rw) {\n\t\t\tmaxd = \"r\";\n\t\t\taccSum = new Uint32Array(r2 + 1);\n\t\t\tfor (let r = r1; r <= r2; r++) {\n\t\t\t\tsum = 0;\n\t\t\t\tfor (let g = g1; g <= g2; g++) {\n\t\t\t\t\tfor (let b = b1; b <= b2; b++) {\n\t\t\t\t\t\tconst index = getColorIndex(r, g, b);\n\t\t\t\t\t\tif (!hist[index]) continue;\n\t\t\t\t\t\tsum += hist[index]!;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ttotal += sum;\n\t\t\t\taccSum[r] = total;\n\t\t\t}\n\t\t} else if (maxw === gw) {\n\t\t\tmaxd = \"g\";\n\t\t\taccSum = new Uint32Array(g2 + 1);\n\t\t\tfor (let g = g1; g <= g2; g++) {\n\t\t\t\tsum = 0;\n\t\t\t\tfor (let r = r1; r <= r2; r++) {\n\t\t\t\t\tfor (let b = b1; b <= b2; b++) {\n\t\t\t\t\t\tconst index = getColorIndex(r, g, b);\n\t\t\t\t\t\tif (!hist[index]) continue;\n\t\t\t\t\t\tsum += hist[index]!;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ttotal += sum;\n\t\t\t\taccSum[g] = total;\n\t\t\t}\n\t\t} else {\n\t\t\tmaxd = \"b\";\n\t\t\taccSum = new Uint32Array(b2 + 1);\n\t\t\tfor (let b = b1; b <= b2; b++) {\n\t\t\t\tsum = 0;\n\t\t\t\tfor (let r = r1; r <= r2; r++) {\n\t\t\t\t\tfor (let g = g1; g <= g2; g++) {\n\t\t\t\t\t\tconst index = getColorIndex(r, g, b);\n\t\t\t\t\t\tif (!hist[index]) continue;\n\t\t\t\t\t\tsum += hist[index]!;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ttotal += sum;\n\t\t\t\taccSum[b] = total;\n\t\t\t}\n\t\t}\n\n\t\tlet splitPoint = -1;\n\t\tconst reverseSum = new Uint32Array(accSum.length);\n\t\tfor (let i = 0; i < accSum.length; i++) {\n\t\t\tconst d = accSum[i];\n\t\t\tif (!d) continue;\n\t\t\tif (splitPoint < 0 && d > total / 2) splitPoint = i;\n\t\t\treverseSum[i] = total - d;\n\t\t}\n\n\t\tconst vbox = this;\n\n\t\tfunction doCut(d: string): VBox[] {\n\t\t\tconst dim1 = d + \"1\";\n\t\t\tconst dim2 = d + \"2\";\n\t\t\tconst d1 = vbox.dimension[dim1]!;\n\t\t\tlet d2 = vbox.dimension[dim2]!;\n\t\t\tconst vbox1 = vbox.clone();\n\t\t\tconst vbox2 = vbox.clone();\n\t\t\tconst left = splitPoint - d1;\n\t\t\tconst right = d2 - splitPoint;\n\n\t\t\tif (left <= right) {\n\t\t\t\td2 = Math.min(d2 - 1, ~~(splitPoint + right / 2));\n\t\t\t\td2 = Math.max(0, d2);\n\t\t\t} else {\n\t\t\t\td2 = Math.max(d1, ~~(splitPoint - 1 - left / 2));\n\t\t\t\td2 = Math.min(vbox.dimension[dim2]!, d2);\n\t\t\t}\n\n\t\t\twhile (!accSum![d2]) d2++;\n\n\t\t\tlet c2 = reverseSum[d2];\n\t\t\twhile (!c2 && accSum![d2 - 1]) c2 = reverseSum[--d2];\n\n\t\t\tvbox1.dimension[dim2] = d2;\n\t\t\tvbox2.dimension[dim1] = d2 + 1;\n\n\t\t\treturn [vbox1, vbox2];\n\t\t}\n\n\t\treturn doCut(maxd);\n\t}\n}\n"],"names":["Histogram"],"mappings":"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"}