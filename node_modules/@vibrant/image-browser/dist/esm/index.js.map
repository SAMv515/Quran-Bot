{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import { ImageBase } from \"@vibrant/image\";\nimport type {\n\tImageSource,\n\tImageData as VibrantImageData,\n} from \"@vibrant/image\";\n\nfunction isRelativeUrl(url: string): boolean {\n\tconst u = new URL(url, location.href);\n\treturn (\n\t\tu.protocol === location.protocol &&\n\t\tu.host === location.host &&\n\t\tu.port === location.port\n\t);\n}\n\nfunction isSameOrigin(a: string, b: string): boolean {\n\tconst ua = new URL(a);\n\tconst ub = new URL(b);\n\n\t// https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\n\treturn (\n\t\tua.protocol === ub.protocol &&\n\t\tua.hostname === ub.hostname &&\n\t\tua.port === ub.port\n\t);\n}\n\nexport class BrowserImage extends ImageBase {\n\timage: HTMLImageElement | undefined;\n\tprivate _canvas: HTMLCanvasElement | undefined;\n\tprivate _context: CanvasRenderingContext2D | undefined;\n\tprivate _width: number | undefined;\n\tprivate _height: number | undefined;\n\n\tprivate _getCanvas() {\n\t\tif (!this._canvas) {\n\t\t\tthrow new Error(\"Canvas is not initialized\");\n\t\t}\n\n\t\treturn this._canvas;\n\t}\n\tprivate _getContext() {\n\t\tif (!this._context) {\n\t\t\tthrow new Error(\"Context is not initialized\");\n\t\t}\n\n\t\treturn this._context;\n\t}\n\tprivate _getWidth() {\n\t\tif (!this._width) {\n\t\t\tthrow new Error(\"Width is not initialized\");\n\t\t}\n\n\t\treturn this._width;\n\t}\n\tprivate _getHeight() {\n\t\tif (!this._height) {\n\t\t\tthrow new Error(\"Height is not initialized\");\n\t\t}\n\n\t\treturn this._height;\n\t}\n\n\tprivate _initCanvas(): void {\n\t\tconst img = this.image;\n\t\tif (!img) {\n\t\t\tthrow new Error(\"Image is not initialized\");\n\t\t}\n\t\tconst canvas = (this._canvas = document.createElement(\"canvas\"));\n\t\tconst context = canvas.getContext(\"2d\");\n\n\t\tif (!context) throw new ReferenceError(\"Failed to create canvas context\");\n\n\t\tthis._context = context;\n\n\t\tcanvas.className = \"@vibrant/canvas\";\n\t\tcanvas.style.display = \"none\";\n\n\t\tthis._width = canvas.width = img.width;\n\t\tthis._height = canvas.height = img.height;\n\n\t\tcontext.drawImage(img, 0, 0);\n\n\t\tdocument.body.appendChild(canvas);\n\t}\n\n\tload(image: ImageSource): Promise<this> {\n\t\tlet img: HTMLImageElement;\n\t\tlet src: string;\n\t\tif (typeof image === \"string\") {\n\t\t\timg = document.createElement(\"img\");\n\t\t\tsrc = image;\n\n\t\t\tif (!isRelativeUrl(src) && !isSameOrigin(window.location.href, src)) {\n\t\t\t\timg.crossOrigin = \"anonymous\";\n\t\t\t}\n\n\t\t\timg.src = src;\n\t\t} else if (image instanceof HTMLImageElement) {\n\t\t\timg = image;\n\t\t\tsrc = image.src;\n\t\t} else {\n\t\t\treturn Promise.reject(\n\t\t\t\tnew Error(`Cannot load buffer as an image in browser`),\n\t\t\t);\n\t\t}\n\t\tthis.image = img;\n\n\t\treturn new Promise<this>((resolve, reject) => {\n\t\t\tconst onImageLoad = () => {\n\t\t\t\tthis._initCanvas();\n\t\t\t\tresolve(this);\n\t\t\t};\n\n\t\t\tif (img.complete) {\n\t\t\t\t// Already loaded\n\t\t\t\tonImageLoad();\n\t\t\t} else {\n\t\t\t\timg.onload = onImageLoad;\n\t\t\t\timg.onerror = (_e) => reject(new Error(`Fail to load image: ${src}`));\n\t\t\t}\n\t\t});\n\t}\n\n\tclear(): void {\n\t\tthis._getContext().clearRect(0, 0, this._getWidth(), this._getHeight());\n\t}\n\n\tupdate(imageData: VibrantImageData): void {\n\t\tthis._getContext().putImageData(imageData as ImageData, 0, 0);\n\t}\n\n\tgetWidth(): number {\n\t\treturn this._getWidth();\n\t}\n\n\tgetHeight(): number {\n\t\treturn this._getHeight();\n\t}\n\n\tresize(targetWidth: number, targetHeight: number, ratio: number): void {\n\t\tif (!this.image) {\n\t\t\tthrow new Error(\"Image is not initialized\");\n\t\t}\n\t\tthis._width = this._getCanvas().width = targetWidth;\n\t\tthis._height = this._getCanvas().height = targetHeight;\n\n\t\tthis._getContext().scale(ratio, ratio);\n\t\tthis._getContext().drawImage(this.image, 0, 0);\n\t}\n\n\tgetPixelCount(): number {\n\t\treturn this._getWidth() * this._getHeight();\n\t}\n\n\tgetImageData(): ImageData {\n\t\treturn this._getContext().getImageData(\n\t\t\t0,\n\t\t\t0,\n\t\t\tthis._getWidth(),\n\t\t\tthis._getHeight(),\n\t\t);\n\t}\n\n\tremove(): void {\n\t\tif (this._canvas && this._canvas.parentNode) {\n\t\t\tthis._canvas.parentNode.removeChild(this._canvas);\n\t\t}\n\t}\n}\n"],"names":[],"mappings":"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"}